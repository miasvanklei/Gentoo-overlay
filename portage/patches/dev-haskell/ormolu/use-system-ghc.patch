--- a/ormolu.cabal	2022-02-19 20:55:08.004410822 +0100
+++ b/ormolu.cabal	2022-02-19 20:58:40.085220085 +0100
@@ -30,6 +30,13 @@
     default:     False
     manual:      True
 
+flag ghc-lib
+    description:
+        Force dependency on ghc-lib-parser even if GHC API in the ghc package is supported
+
+    default:     False
+    manual:      True
+
 library
     exposed-modules:
         Ormolu
@@ -88,7 +95,6 @@
         containers >=0.5 && <0.7,
         dlist >=0.8 && <2.0,
         exceptions >=0.6 && <0.11,
-        ghc-lib-parser >=9.2 && <9.3,
         mtl >=2.0 && <3.0,
         syb >=0.7 && <0.8,
         text >=0.2 && <1.3,
@@ -96,6 +102,14 @@
         directory ^>=1.3,
         Cabal ^>=3.4
 
+    if ((!flag(ghc-lib) && impl(ghc >=9.2)) && impl(ghc <9.3))
+        build-depends:
+            ghc ==9.2.*,
+            ghc-boot-th -any,
+            ghc-boot -any
+    else
+        build-depends: ghc-lib-parser ==9.0.*
+
     if flag(dev)
         ghc-options:
             -Wall -Werror -Wcompat -Wincomplete-record-updates
@@ -121,12 +135,19 @@
     build-depends:
         base >=4.12 && <5.0,
         filepath >=1.2 && <1.5,
-        ghc-lib-parser >=9.2 && <9.3,
         gitrev >=1.3 && <1.4,
         optparse-applicative >=0.14 && <0.17,
         ormolu,
         text >=0.2 && <1.3
 
+    if ((!flag(ghc-lib) && impl(ghc >=9.2)) && impl(ghc <9.3))
+        build-depends:
+            ghc ==9.2.*,
+            ghc-boot-th -any,
+            ghc-boot -any
+    else
+        build-depends: ghc-lib-parser ==9.0.*
+
     if flag(dev)
         ghc-options:
             -Wall -Werror -Wcompat -Wincomplete-record-updates
