diff --color -ur a/ell/cert.c b/ell/cert.c
--- a/ell/cert.c	2021-05-02 13:06:43.000000000 +0200
+++ b/ell/cert.c	2021-05-14 11:46:46.527476860 +0200
@@ -451,7 +451,7 @@
 					const char **error)
 {
 	struct l_keyring *ca_ring = NULL;
-	_auto_(l_keyring_free) struct l_keyring *verify_ring = NULL;
+	autofree struct l_keyring *verify_ring = NULL;
 	struct l_cert *cert;
 	struct l_key *prev_key = NULL;
 	int verified = 0;
diff --color -ur a/ell/tls.c b/ell/tls.c
--- a/ell/tls.c	2021-05-02 13:06:43.000000000 +0200
+++ b/ell/tls.c	2021-05-14 11:46:46.527476860 +0200
@@ -1892,7 +1892,7 @@
 					const uint8_t *buf, size_t len)
 {
 	size_t total;
-	_auto_(l_certchain_free) struct l_certchain *certchain = NULL;
+	autofree struct l_certchain *certchain = NULL;
 	struct l_cert *leaf;
 	size_t der_len;
 	const uint8_t *der;
diff --color -ur a/ell/useful.h b/ell/useful.h
--- a/ell/useful.h	2021-03-29 14:19:13.000000000 +0200
+++ b/ell/useful.h	2021-05-14 11:46:46.527476860 +0200
@@ -52,13 +52,12 @@
 	return (oct >> start) & mask;
 }
 
-#define __AUTODESTRUCT(var, func)			\
-	void cleanup_ ## var(void *ptr)			\
-	{ func(*(void **) ptr); }			\
-	__attribute((cleanup(cleanup_ ## var)))
-
-#define _AUTODESTRUCT(var, func)			\
-	__AUTODESTRUCT(var, func)
+static inline void
+autoptr_cleanup_generic_free (void *p)
+{
+  void **pp = (void**)p;
+  free (*pp);
+}
 
-#define _auto_(func)					\
-	_AUTODESTRUCT(__COUNTER__, func)
+#define _CLEANUP(func) __attribute__((cleanup(func)))
+#define autofree _CLEANUP(autoptr_cleanup_generic_free)
