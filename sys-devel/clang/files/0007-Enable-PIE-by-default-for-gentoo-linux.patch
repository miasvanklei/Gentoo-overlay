From efbdf70c883a356106fc1bcb1c2917ec6c0a6157 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Tue, 23 Feb 2016 09:35:26 +0100
Subject: [PATCH 5/7] Enable PIE by default for alpine linux

Alpine Linux uses PIE by default.
---
 lib/Driver/ToolChains.cpp |  5 ++++-
 lib/Driver/Tools.cpp      |  1 +
 2 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/lib/Driver/ToolChains.cpp b/lib/Driver/ToolChains.cpp
index 0db9644..82449bf 100644
--- a/lib/Driver/ToolChains.cpp
+++ b/lib/Driver/ToolChains.cpp
@@ -4617,7 +4667,9 @@
   }
 }
 
-bool Linux::isPIEDefault() const { return getSanitizerArgs().requiresPIE(); }
+bool Linux::isPIEDefault() const {
+  return getSanitizerArgs().requiresPIE() || Linux::getTriple().getVendorName().compare("gentoo") == 0;
+}
 
 SanitizerMask Linux::getSupportedSanitizers() const {
   const bool IsX86 = getTriple().getArch() == llvm::Triple::x86;
diff --git a/lib/Driver/Tools.cpp b/lib/Driver/Tools.cpp
index ea1ce6f..8fd3649 100644
--- a/lib/Driver/Tools.cpp
+++ b/lib/Driver/Tools.cpp
@@ -9358,7 +9358,7 @@
   const bool isAndroid = ToolChain.getTriple().isAndroid();
   const bool IsIAMCU = ToolChain.getTriple().isOSIAMCU();
   const bool IsPIE =
-      !Args.hasArg(options::OPT_shared) && !Args.hasArg(options::OPT_static) &&
+      !Args.hasArg(options::OPT_shared) && !Args.hasArg(options::OPT_fno_pie) &&
       (Args.hasArg(options::OPT_pie) || ToolChain.isPIEDefault());
   const bool HasCRTBeginEndFiles =
       ToolChain.getTriple().hasEnvironment() ||
@@ -9413,6 +9413,9 @@
       CmdArgs.push_back("-Bstatic");
     else
       CmdArgs.push_back("-static");
+    if (isPIE) {
+	CmdArgs.push_back("-Bsymbolic");
+    }
   } else if (Args.hasArg(options::OPT_shared)) {
     CmdArgs.push_back("-shared");
   }
@@ -9438,6 +9441,8 @@
       if (!Args.hasArg(options::OPT_shared)) {
         if (Args.hasArg(options::OPT_pg))
           crt1 = "gcrt1.o";
+        else if (isPIE && Args.hasArg(options::OPT_static))
+          crt1 = "rcrt1.o";
         else if (IsPIE)
           crt1 = "Scrt1.o";
         else
-- 
2.7.3
