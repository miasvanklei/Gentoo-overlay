From 7baf030be2225de46f7a5d869451de99e3b99f5e Mon Sep 17 00:00:00 2001
From: Emil Renner Berthing <systemd@esmil.dk>
Date: Thu, 18 Sep 2014 15:24:49 +0200
Subject: [PATCH] shared/missing.h: check for missing strndupa

include missing.h  for definition of strndupa

Signed-off-by: Khem Raj <raj.khem@gmail.com>
---
 configure.ac           |  3 ++-
 src/basic/missing.h    | 11 +++++++++++
 src/basic/mkdir.c      |  1 +
 src/shared/pager.c     |  1 +
 src/shared/uid-range.c |  1 +
 5 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index ec794b4..ab9abcc 100644
--- a/configure.ac
+++ b/configure.ac
@@ -306,6 +306,7 @@
         renameat2,
         kcmp,
         keyctl,
+        strndupa,
         LO_FLAGS_PARTSCAN,
         copy_file_range],
         [], [], [[
@@ -314,6 +315,7 @@
 #include <sys/mount.h>
 #include <fcntl.h>
 #include <sched.h>
+#include <string.h>
 #include <linux/loop.h>
 #include <linux/random.h>
 ]])
diff --git a/src/basic/missing.h b/src/basic/missing.h
index ee1d81a..253dd49 100644
--- a/src/basic/missing.h
+++ b/src/basic/missing.h
@@ -1132,6 +1132,17 @@ static inline key_serial_t request_key(const char *type, const char *description
 }
 #endif
 
+#if !HAVE_DECL_STRNDUPA
+#define strndupa(s, n) \
+  ({ \
+    const char *__old = (s); \
+    size_t __len = strnlen(__old, (n)); \
+    char *__new = (char *)alloca(__len + 1); \
+    __new[__len] = '\0'; \
+    (char *)memcpy(__new, __old, __len); \
+  })
+#endif
+
 #ifndef KEYCTL_READ
 #define KEYCTL_READ 11
 #endif
diff --git a/src/basic/mkdir.c b/src/basic/mkdir.c
index 6b1a984..d1388df 100644
--- a/src/basic/mkdir.c
+++ b/src/basic/mkdir.c
@@ -28,6 +28,7 @@
 #include "path-util.h"
 #include "stat-util.h"
 #include "user-util.h"
+#include "missing.h"
 
 int mkdir_safe_internal(const char *path, mode_t mode, uid_t uid, gid_t gid, mkdir_func_t _mkdir) {
         struct stat st;
diff --git a/src/shared/pager.c b/src/shared/pager.c
index c16bc02..3bec27b 100644
--- a/src/shared/pager.c
+++ b/src/shared/pager.c
@@ -37,6 +37,7 @@
 #include "signal-util.h"
 #include "string-util.h"
 #include "terminal-util.h"
+#include "missing.h"
 
 static pid_t pager_pid = 0;
 
diff --git a/src/shared/uid-range.c b/src/shared/uid-range.c
index b6ec474..91ce9fb 100644
--- a/src/shared/uid-range.c
+++ b/src/shared/uid-range.c
@@ -24,6 +24,7 @@
 #include "macro.h"
 #include "uid-range.h"
 #include "user-util.h"
+#include "missing.h"
 
 static bool uid_range_intersect(UidRange *range, uid_t start, uid_t nr) {
         assert(range);
